# 1.21.2 Raid Farm Development Notes

## Participants

- Youmiel

## Development Motivation

1.21.2 changed the raid mob spawn method from the original 64, 32 radius rings plus 5*5 center to a ring whose radius decreases with raid spawn countdown, and when countdown is 0, the attempted spawn position isn't at raid center either. Additionally, spawn position has height difference restrictions relative to raid center. So the original spawn platform design no longer suits versions 1.21.2 and above.

## Mechanics Research

### Determining Spawn Range (2024-12-27)

Although the [research notes](../../articles/2024-06__1-21_raid/mechanic_note.md) roughly revealed the shape of spawn range at `t=0` (a certain radius ring with xz shifted 1~2 blocks each overlaid), the exact appearance was unknown. To accurately determine spawn range, I conducted the following experiment:

1. Prepare a sufficiently large white concrete platform; 48 * 48 was used here
2. Place a villager POI 80 blocks above platform center
3. AFK one player near this POI, give Bad Omen via command every 900gt
4. Place command block chain near platform bottom center to change white concrete under spawned raiders within 128 blocks to yellow concrete, and teleport them out of raid range:<br>
```
execute as @e[distance=..128, type=#raiders] at @s run tag @s add raid_marker
execute as @e[tag=raid_marker] at @s if block ~ ~-1 ~ minecraft:white_concrete run setblock ~ ~-1 ~ minecraft:yellow_concrete
execute as @e[tag=raid_marker] at @s if block ~ ~-2 ~ minecraft:white_concrete run setblock ~ ~-2 ~ minecraft:yellow_concrete
execute as @e[tag=raid_marker] at @s run tp ~ ~-2 ~
```
5. Tick warp accelerate for sufficient time, observe pattern on concrete platform.

Experiment setup shown:

![platform](img/raid_farm_1-21-2/spawn_test.png)

Measured spawn range, where gray concrete is raid center; red concrete is positive x-axis; blue concrete is positive z-axis; yellow portion is spawn range for waves other than first wave. First wave necessarily has countdown, spawn position at platform edge, not in figure:

![pattern](img/raid_farm_1-21-2/spawn_pattern.png)

Can see that new raid spawn range only overlaps with old one at 10 blocks.


### Calculating Spawn Probability (2024-12-28)

Ring-shaped spawn range mapped to square grid doesn't have even probability per cell, and the spawn range we're studying consists of 9 rings overlaid. We need to calculate probability per cell to better design raid tower spawn platforms.

Probability calculation method is sampling a point every 0.001pi on the ring, counting points per cell, finally plotting single ring heatmap:

![single_circle](../../articles/2024-06__1-21_raid/img/note/heatmap_circle.png)

Image after overlaying nine rings; comparing with previously measured shape shows they match:

![full_circle](../../articles/2024-06__1-21_raid/img/note/heatmap_full.png)

Code for generating heatmap at: [1-21-2_raid_spawn/sample.ipynb](./1-21-2_raid_spawn/sample.ipynb)

So if calculating final spawn probability for some spawn platform design, method is first get sum `x` of probabilities at platform-covered positions, then calculate `1 - (1-x)^120` for final spawn probability (from [research notes](../../articles/2024-06__1-21_raid/mechanic_note.md) we know that when raid refresh countdown reaches 0, it attempts to find spawn position 120 times). Theoretically, only need to cover range with 4% total probability in single spawn attempt to achieve 99% final spawn success rate.
